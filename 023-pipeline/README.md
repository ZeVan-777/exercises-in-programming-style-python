# 流水线风格

## 约束

- 函数（输入决定输出）抽象分解大问题
- 函数间无状态共享
- 以流水线形式逐个组合函数，类似数学中复合函数 ƒ ∘ g

## 注解

就像工厂的流水线，利用复合函数 `(ƒ ∘ g)(x) = ƒ(g(x))`，**满足第二个`函数g`输出域等于或包含于第一个`函数ƒ**`，即可一层层构成任何函数。

流水线风格试图实现数学般的纯粹，将所有任务都视为**输入集合到输出集合的映射关系**。在纯粹的流水线风格中，除了开始整个计算任务的**数据来源**以及结束时输出结果的**接收容器**，在整个运行过程中，匣子以外的世界是完全不存在的。（词频统计任务需要从文件中读取数据，并不纯粹。）

与之前的[食谱风格](../022-cookbook/README.md)相似，程序被分解为若干较小问题解决具体的计算任务，且过程的划分一致。不同的是，流水线风格的函数都有一个输入参数，并且在过程最后返回结果，在函数之外没有任何状态。这意味着过程的**幂等性** —— 无论调用多少次，何时调用，过程的输出结果都不会改变。拼接函数匣子以组成解决大问题的流水线，只要满足流水线输入输出要求的函数即可替换到对应位置。

```python
def pipeline(*funcs):
    return functools.reduce(lambda f, g: lambda x: f(g(x)), reversed(funcs), lambda x: x)

# 主函数
pipeline(
    read_file,
    filter_chars_and_normalize,
    scan_Words,
    remove_stop_words,
    frequencies,
    sort,
    lambda rankList: rankList[0:25],
    print_all,
)(sys.argv[1])
```

## 发展历程

当人们意识到在许多程序中，有些指令快在程序执行的过程中需要被**执行多次**，这促使了子程序概念出现。高级编程语言中，它们能在程序的任意位置被调用，并在执行完成后返回结果至调用位置 —— 函数在计算机的演化过程中，再一次“被发明”。随着编程语言的发展，函数的概念随处可见，又各有不同，其中流水线模式则忠于数学对函数的定义。

流水线模式在计算机系统工程领域一个最古老、最知名的应用就是`Unix shell 管道`：任意命令间都可以使用“`|`”进行连接，前者的输出会作为后者的输入，如`ps -ax | grep http`。**管道链上的每个命令都相互独立，“消耗”输入，“生产”输出。**

流水线风格也可以被称为函数式编程，尤其适合**本质上能够通过流水线建模的问题**，如编译器和其他语言处理器，因为它们都倾向于利用图和树等数据结构组合过程。除了针对问题的适用性，程序不保留盒函数以外的任何状态让**单元测试**变得容易；盒函数作为运算单元的相互独立性，无需担心同步或状态共享，因而适用于**并发编程**。
